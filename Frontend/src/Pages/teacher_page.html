<!DOCTYPE html>
<html lang="lv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teachers Page</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f8f8;
            margin: 0;
            padding: 0;
        }

        .container {
            width: 80%;
            margin: auto;
        }

        .navbar {
            display: flex;
            justify-content: flex-start; /* Aligns items to the start */
            padding: 0; /* Ensures no extra padding */
            margin-top: 20px; /* Removes any default margin */
            margin-left: 10%;
        }

        .tab {
            background-color: #98a4b0;
            color: white;
            padding: 15px;
            cursor: pointer;
            margin: 0; /* Removes gaps between tabs */
            text-align: center;
            border-radius: 5px 5px 0 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border: none;
            transition: background-color 0.3s ease;
        }


        .tab h3 {
            margin: 0;
        }

        .tab:hover {
            background-color: #05478d;
        }

        .tab.active {
            background-color: #007bff; /* Brighter when active */
        }

        .tab.inactive {
            background-color: #98a4b0; /* Darker when inactive (specifically for PROFILE) */
            cursor: not-allowed; /* Make it look inactive by changing cursor */
        }

        .tab-content {
            width: 100%;
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border: 1px solid #ddd;
            margin-top: 0; /* Remove any space between tabs and content */
        }

        .add-button {
            background-color: rgb(175, 76, 162);
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 18px;
            border-radius: 50%;
        }

        #seminar-list {
            list-style-type: none;
            padding: 0;
        }

        #seminar-list li {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }

        #seminar-list li a {
            text-decoration: none;
            color: #000;
            cursor: pointer;
        }

        /* Add Seminar Popup */
        #add-seminar-popup {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            width: 300px;
            text-align: center;
        }

        #add-seminar-popup input {
            margin-bottom: 15px; /* Add space below inputs */
            width: 80%; /* Ensure inputs and label take full width */
            padding: 10px; /* Increase padding for better readability */
            font-size: 16px;
        }

        #add-seminar-popup button {
            background-color: #007bff;
            color: white;
            padding: 10px;
            border: none;
            cursor: pointer;
            margin-bottom: 10px;
        }

        /* Seminar Popup */
        #seminar-popup {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            width: 80%;  /* Maini atbilstoši nepieciešamajam platumam */
            max-width: 1000px;  /* Maksimālais platums */
            max-height: 80vh;
            overflow: auto;  /* Ja saturs pārsniedz izmēru, parādīsies rullītis */
            margin: auto;
            text-align: center;
        }

        #seminar-popup table {
            width: 100%;
            border-collapse: collapse;
        }

        /* Tabulas konteiners, kas ļaus ritināt tabulas saturu */
        #seminar-popup .table-container {
            max-height: 300px;  /* Piemērs, regulējams atkarībā no vajadzībām */
            overflow-y: auto;  /* Parādīs vertikālo rullīti */
        }

        .seminar-popup-buttons {
            display: flex;
            justify-content: space-evenly;
            margin-bottom: 20px;
        }

        .seminar-popup-buttons button {
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
        }

        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }

        table, th, td {
            border: 1px solid #ddd;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px;
        }

        th {
            background-color: #007bff;
            color: white;
        }

        .checkbox-cell {
            text-align: center;
        }

        /* Add any necessary styles for the file input and buttons */
        .add-btn {
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            border-radius: 5px;
        }

        .action-btn {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 18px;
            margin: 0 5px;
            border-radius: 5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .edit-btn {
            background-color: #f0ad4e;
            border: none;
            cursor: pointer;
        }

        .delete-btn {
            background-color: #d9534f;
            border: none;
            cursor: pointer;
        }

        /* Specific styles for each button */
        .envelope-btn {
            background-color: #007bff;
            color: white;
        }

        .invite-btn {
            background-color: #28a745;
            color: white;
        }

        /* Confirmation Dialog */
        #confirmation-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 18px;
        }

        #confirmation-dialog button {
            background-color: #f0ad4e;
            color: white;
            border: none;
            padding: 10px;
            margin: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        #confirmation-dialog button:hover {
            background-color: #e0852f;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border: 1px solid #888;
            max-width: 600px; /* Pielāgojiet vērtību pēc vajadzības */
            width: 90%;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column; /* Align items vertically */
            align-items: center; /* Center items horizontally */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            box-sizing: border-box;
        }

        .register-btn {
            background-color: #007bff;
            color: white;
            padding: 10px;
            border: none;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .close-btn {
            color: #007bff;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute; /* Position it at the top right */
            top: 10px; /* Adjust the distance from the top */
            right: 10px; /* Adjust the distance from the right */
        }

        .close-btn:hover,
        .close-btn:focus {
            color: rgb(0, 28, 139);
            cursor: pointer;
        }

        /* Add space between input fields and button */
        .modal-content input,
        .modal-content label {
            margin-bottom: 15px; /* Add space below inputs */
            width: 100%; /* Ensure inputs and label take full width */
            padding: 10px; /* Increase padding for better readability */
            font-size: 16px; /* Increase font size */
        }

        .modal-content input[type="checkbox"] {
            margin-right: 10px; /* Add some space between the checkbox and the text */
            width: auto; /* Ensure the checkbox maintains its default size */
            height: auto;       
        }

        /* Make button spacing more consistent */
        .modal-content button {
            margin-top: 10px; /* Add some space above the button */
            padding: 12px 20px; /* Increase padding for a better button size */
            font-size: 16px; /* Increase button font size */
            cursor: pointer;
        }
        /* General button hover effect */
        button:hover {
            background-color: #0056b3;
        }
        /* Specific hover effect for the Save, Add Instructor, and Register buttons */
        .add-btn:hover,
        .register:hover,
        .save-btn:hover {
            background-color: #0056b3; /* Darker blue for these buttons */
            color: white; /* Keep the text color white */
        }

        .sortable-header {
            position: relative;
            cursor: pointer;
        }

        .sortable-header::after {
            content: '';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 5px solid black; /* Default arrow pointing down */
            opacity: 0.5;
        }

        .sortable-header.asc::after {
            border-bottom: 5px solid black; /* Arrow pointing down */
            border-top: none;
        }

        .sortable-header.desc::after {
            border-top: 5px solid black; /* Arrow pointing up */
            border-bottom: none;
        }

        /* Noņemam bultiņu no pirmās kolonnas (Actions) */
        th:first-child::after {
            display: none !important; /* Pilnībā noņemam bultiņu */
        }

        #create-teams-modal {
            width: 400px; /* Pielāgojiet platumu pēc vajadzības */
            padding: 20px;
        }

        #teams-input-container {
            width: 100%; /* Iestatiet konteinera platumu uz 100% */
        }

        .team-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
            box-sizing: border-box; /* Iekļaut padding un border platumā */
        }

        .add-team-button-container {
            text-align: right; /* Novietojiet pogu labajā pusē */
            margin-bottom: 15px;
        }

        .add-team-button-container button {
            background-color: rgb(175, 76, 162);
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 18px;
            border-radius: 50%; /* Padariet pogu apaļu */
            cursor: pointer;
            min-width: 43px; /* Pielāgojiet vērtību pēc vajadzības */
            min-height: 43px;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end; /* Izlīdziniet pogas pa labi */
            margin-top: 20px;
        }
        
        .modal-buttons button {
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px; /* Pievienojiet atstarpi starp pogām */

        }
        
        .register-btn:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>  
    <div class="navbar">
        <div class="tab" onclick="openTab('papers')"><h3>PAPERS</h3></div>
        <div class="tab" onclick="openTab('students')"><h3>STUDENTS</h3></div>
        <div class="tab" onclick="openTab('seminars')"><h3>SEMINARS</h3></div>
        <div class="tab" onclick="openTab('profile')"><h3>PROFILE</h3></div>
    </div>
    
    <div class="container">
        <!-- Papers Tab -->
        <div id="papers" class="tab-content">
            <button class="add-button" onclick="document.getElementById('paper-file-input').click()">+</button>
            <h2>Papers</h2>
            <div class="table-container">
                <table id="paper-table">
                    <thead>
                        <tr>
                            <th>Nr.</th>
                            <th class="sortable-header" onclick="sortTable(1)">Paper Name</th>
                            <th class="sortable-header" onclick="sortTable(2)">Student Name</th>
                        </tr>
                    </thead>
                    <tbody id="paper-table-body">
                        <!-- Student rows will be inserted here dynamically -->
                    </tbody>
                </table>
            </div>
            <input type="file" id="paper-file-input" accept=".pdf" style="display:none;" multiple>
            <div id="message"></div>
        </div>

        <!-- Students Tab -->
        <div id="students" class="tab-content">
            <h2>Students</h2>
            <button class="add-btn" onclick="toggleAddStudents()">+ Add Students</button>
            <input type="file" id="file-input" accept=".xlsx" style="display:none;">
            <button class="add-btn" onclick="document.getElementById('file-input').click()">Import Students</button>
            <button class="add-btn" onclick="exportStudents()">Export Students</button>
            <div id="add-students-modal" class="modal" style="display:none;">
                <!-- Modal content for adding students manually -->
                <div class="modal-content">
                    <span class="close-btn" onclick="closeModal()">&times;</span>
                    <h3>Add Students</h3>
                    <input type="text" id="new-name" placeholder="Name">
                    <input type="text" id="new-surname" placeholder="Surname">
                    <input type="email" id="new-email" placeholder="Email">
                    <label>
                        <input type="checkbox" id="send-email"> Send email 
                    </label>
                    <button onclick="addStudent()" class="add-btn">Register</button>
                </div>
            </div>
            <div class="table-container">
                <table id="student-table">
                    <thead>
                        <tr>
                            <th>Actions</th>
                            <th class="sortable-header" onclick="sortTable(1)">Last Name</th>
                            <th class="sortable-header" onclick="sortTable(2)">First Name</th>
                            <th class="sortable-header" onclick="sortTable(3)">Email</th>
                        </tr>
                    </thead>
                    <tbody id="student-table-body">
                        <!-- Student rows will be inserted here dynamically -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Seminars Tab -->
        <div id="seminars" class="tab-content">
            <button class="add-button" onclick="addSeminar()">+</button>
            <h2>Seminars</h2>
            <ul id="seminar-list">
                <li><a href="#" onclick="openSeminarPopup(1, 'Seminar 1')">Seminar #1</a></li>
                <li><a href="#" onclick="openSeminarPopup(2, 'Seminar 2')">Seminar #2</a></li>
            </ul>
        </div>

        <!-- Profile Tab -->
        <div id="profile" class="tab-content">
            <h2>Profile</h2>
            <button onclick="editData(this)" class="add-btn">Edit data</button>
            <button onclick="changePassword(this)" class="add-btn">Change password</button>
            <table>
                <tr><td>Name:</td><td><input type="text" id="name" value="{{ pasniedzejs.name }}" readonly></td></tr>
                <tr><td>Surname:</td><td><input type="text" id="surname" value="{{ pasniedzejs.surname }}" readonly></td></tr>
                <tr><td>Username:</td><td><input type="text" id="username" value="{{ pasniedzejs.username }}" readonly></td></tr>
                <tr><td>Email:</td><td><input type="email" id="email" value="{{ pasniedzejs.email }}" readonly></td></tr>
                <tr><td>Password:</td><td><input type="password" id="password" value="{{ pasniedzejs.password }}" readonly></td></tr>
            </table>
        </div>
    </div>

    <!-- Add Seminar Popup -->
    <div id="add-seminar-popup" class="modal-content" style="display: none;">
        <h3>Add Seminar</h3>
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <input type="text" id="seminar-name" placeholder="Seminar name">
        <button class="add-btn" onclick="addNewSeminar()">Add</button>
    </div>
    
    <!-- Seminar Popup -->
    <div id="seminar-popup">
        <h3 id="seminar-popup-title"></h3>
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <div class="seminar-popup-buttons">
            <button>Evaluation parameters</button>
            <button>Dates</button>
            <button>Download presentations</button>
            <button>Export grades</button>
            <button onclick="openCreateTeamsModal()">Create teams</button> </div>
            <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Nr.</th>
                        <th>Paper</th>
                        <th>Student name</th>
                        <th>Team name</th>
                        <th>Present</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            </div>
    </div>
    
    <div id="create-teams-modal" class="modal-content" style="display: none;">
        <span class="close-btn" onclick="closeCreateTeamsModal()">&times;</span>
        <h3>Create Teams</h3>
        <div class="add-team-button-container">
            <button class="add-button" onclick="addTeamInput()">+</button>
        </div>
        <div id="teams-input-container">
            <input type="text" placeholder="Team Name" class="team-input">
        </div>
        <button class="register-btn" onclick="registerTeams()">Register</button>
    </div>

    <!-- Confirmation Dialog -->
    <div id="confirmation-dialog" style="display: none;">
        <p>Are you sure you want to delete this student?</p>
        <button onclick="deleteStudent()">Yes</button>
        <button onclick="cancelDelete()">No</button>
    </div>

    <script>

    function openCreateTeamsModal() {
        document.getElementById("create-teams-modal").style.display = "flex";
    }

    function closeCreateTeamsModal() {
        document.getElementById("create-teams-modal").style.display = "none";
    }

    function addTeamInput() {
        let container = document.getElementById("teams-input-container");
        let newInput = document.createElement("input");
        newInput.type = "text";
        newInput.placeholder = "Team Name";
        newInput.className = "team-input";
        container.appendChild(newInput);
    }


    // Add event listener to the file input
    document.getElementById('paper-file-input').addEventListener('change', function(event) {
    const files = event.target.files;

    // Pārbauda, vai fails ir izvēlēts
    if (files.length === 0) {
        alert('Lūdzu, izvēlieties PDF failu!'); 
        return;
    }

    // Pārbauda, vai fails ir PDF formātā
    if (files[0].type !== 'application/pdf') {
        alert('Lūdzu, izvēlieties tikai PDF failu!'); 
        return;
    }

    // Augšupielādē failu
    uploadFile(files[0]);
});

function uploadFiles(files) {
    const formData = new FormData();

    // Pievienojam katru failu FormData objektam
    for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
    }

    fetch('/pasniedzejs/upload_pdf', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        console.log('Backend response:', data); // Debug log
        if (data.success) {
            // Ja backend atgriež masīvu ar failiem
            if (Array.isArray(data.files)) {
                data.files.forEach(file => {
                    addPaperToTable(file);
                });
            } else {
                // Ja backend atgriež vienu failu
                addPaperToTable(data.file);
            }
        } else {
            alert('Kļūda: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Kļūda:', error);
        alert('Kļūda augšupielādējot PDF failus.');
    });
}

document.getElementById('paper-file-input').addEventListener('change', function(event) {
    const files = event.target.files;

    // Pārbauda, vai faili ir izvēlēti
    if (files.length === 0) {
        alert('Lūdzu, izvēlieties PDF failus!'); 
        return;
    }

    // Pārbauda, vai visi faili ir PDF formātā
    for (let i = 0; i < files.length; i++) {
        if (files[i].type !== 'application/pdf') {
            alert('Lūdzu, izvēlieties tikai PDF failus!'); 
            return;
        }
    }

    // Augšupielādē failus
    uploadFiles(files);
});

function addPaperToTable(file) {
    const tableBody = document.getElementById('paper-table-body');
    const newRow = tableBody.insertRow();

    const cell1 = newRow.insertCell(0); // Nr.
    const cell2 = newRow.insertCell(1); // Paper Name (Plain Text)
    const cell3 = newRow.insertCell(2); // Student Name

    cell1.textContent = tableBody.rows.length;
    cell2.textContent = file.title || "Unknown"; // Ja title nav definēts, izmantojiet "Unknown"
    cell3.textContent = file.student_name || "No student assigned"; // Ja student_name nav definēts, izmantojiet "No student assigned"

    console.log('Row added to table:', file); // Debug log
}

        function addSeminar() {
            // Parādīt popup logu ar semināra pievienošanas formu
            document.getElementById("add-seminar-popup").style.display = "block";
        }

        function closeAddSeminarPopup() {
            // Aizvērt popup logu
            document.getElementById("add-seminar-popup").style.display = "none";
        }

        function addNewSeminar() {
            let seminarName = document.getElementById("seminar-name").value;
            if (seminarName.trim() !== "") {
                let seminarList = document.getElementById("seminar-list");
                let newSeminar = document.createElement("li");
                let seminarNum = seminarList.children.length + 1;
                newSeminar.innerHTML = `<a href='#' onclick='openSeminarPopup(${seminarNum}, "${seminarName}")'>${seminarName}</a>`;
                seminarList.appendChild(newSeminar);
            }
            closeAddSeminarPopup(); // Aizvērt popup pēc semināra pievienošanas
        }

        function openSeminarPopup(seminarNum, seminarName) {
            // Iestata semināra nosaukumu
            document.getElementById("seminar-popup-title").innerText = seminarName;

            // Parāda papildlogu ar pogām un tabulu
            document.getElementById("seminar-popup").style.display = "block";
        }

        function closeSeminarPopup() {
            document.getElementById("seminar-popup").style.display = "none";
        }

        // Function to open a specific tab
        function openTab(tabName) {
            console.log(`Opening tab: ${tabName}`);  // Debugging
            let tabs = document.getElementsByClassName("tab-content");
            let tabButtons = document.getElementsByClassName("tab");

            // Hide all tab-content elements
            for (let tab of tabs) {
                tab.style.display = "none";
            }

            // Remove "active" class from all tabs
            for (let button of tabButtons) {
                button.classList.remove("active");
            }

            // Show the selected tab
            document.getElementById(tabName).style.display = "block";

            // Add "active" class to the selected tab
            const activeButton = Array.from(tabButtons).find(button => button.innerText.toLowerCase() === tabName);
            if (activeButton) {
                activeButton.classList.add("active");
            }
        }

        // Open the profile tab by default
        document.addEventListener('DOMContentLoaded', () => {
            openTab('profile');  // Ensure the profile tab is opened by default
        });

        // Toggle the Add Students modal
        function toggleAddStudents() {
            let modal = document.getElementById("add-students-modal");
            modal.style.display = modal.style.display === "none" ? "block" : "none";
        }

        // Add Student
        function addStudent() {
            let name = document.getElementById("new-name").value;
            let surname = document.getElementById("new-surname").value;
            let email = document.getElementById("new-email").value;
            let sendEmail = document.getElementById("send-email").checked;

            // Validation
            if (!name || !surname || !email) {
                alert("Please fill in all fields!");
                return;
            }

            // Send data to the backend to add the student
            fetch('/pasniedzejs/add_student', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name, surname, email })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Add new student to the table dynamically
                    let tableBody = document.getElementById("student-table-body");
                    let newRow = tableBody.insertRow();
                    newRow.setAttribute("data-id", data.id); // Set the data-id attribute with the student ID
                    newRow.innerHTML = 
                        `<td>
                            <button class="action-btn envelope-btn" onclick="sendEmail('${email}')"><i class="fas fa-envelope"></i></button>
                            <button class="action-btn edit-btn" onclick="editStudent(this)"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-btn" onclick="confirmDelete(this)"><i class="fas fa-times-circle"></i></button>
                            <button class="action-btn invite-btn" onclick="sendInvitation('${email}')"><i class="fas fa-paper-plane"></i></button>
                        </td>
                        <td>${surname}</td>
                        <td>${name}</td>
                        <td>${email}</td>
                    `;

                    // Clear form fields and close modal
                    document.getElementById("new-name").value = '';
                    document.getElementById("new-surname").value = '';
                    document.getElementById("new-email").value = '';
                    closeModal();

                    // Send email if checkbox is checked
                    if (sendEmail) {
                        let mailString = `Hello! You have been added as a new student. Welcome, ${name} ${surname}!`;
                        window.location.href = `mailto:${email}?subject=New Student&body=${mailString}`;
                    }
                } else {
                    alert("Error adding student: " + data.error);
                }
            })
            .catch(error => {
                console.error("Error adding student:", error);
                alert("An error occurred while adding the student.");
            });
        }

        // Close modal
        function closeModal() {
            document.getElementById("add-students-modal").style.display = "none";
            document.getElementById("add-seminar-popup").style.display = "none";
            document.getElementById("seminar-popup").style.display = "none";
        }

        // Send email
        function sendEmail(email) {
            window.location.href = `mailto:${email}`;
        }

        // Edit student
        function editStudent(button) {
            let row = button.closest('tr');
            let cells = row.cells;
            let studentId = row.getAttribute('data-id'); // Capture the student ID

            if (!studentId) {
                alert("Student ID not found!");
                return;
            }

            // Replace text with input fields
            cells[1].innerHTML = `<input type="text" value="${cells[1].innerText}">`;
            cells[2].innerHTML = `<input type="text" value="${cells[2].innerText}">`;
            cells[3].innerHTML = `<input type="text" value="${cells[3].innerText}">`;

            // Add a save button next to existing buttons instead of replacing them
            let actionCell = cells[0];
            if (!actionCell.querySelector('.save-btn')) {
                let saveButton = document.createElement("button");
                saveButton.classList.add("action-btn", "save-btn");
                saveButton.innerText = "Save";
                saveButton.onclick = function() { saveStudent(this); }; // Pass the button to saveStudent

                actionCell.appendChild(saveButton);
            }
        }

        // Save student changes
        function saveStudent(button) {
    let row = button.closest('tr');
    let cells = row.cells;
    let studentId = row.getAttribute('data-id'); // Retrieve the student ID from the row

    if (!studentId) {
        alert("Student ID not found!");
        return;
    }

    // Get new values
    let surname = cells[1].querySelector('input').value;
    let name = cells[2].querySelector('input').value;
    let email = cells[3].querySelector('input').value;

    // Validate new values
    if (!name || !surname || !email) {
        alert("All fields are required!");
        return;
    }

    // Send updated data to the backend
    fetch('/pasniedzejs/edit_student', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: studentId, name, surname, email })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok ' + response.statusText);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Replace input fields with text in the table
            cells[1].innerText = surname;
            cells[2].innerText = name;
            cells[3].innerText = email;

            // Restore action buttons
            cells[0].innerHTML = `
                <button class="action-btn envelope-btn" onclick="sendEmail('${email}')"><i class="fas fa-envelope"></i></button>
                <button class="action-btn edit-btn" onclick="editStudent(this)"><i class="fas fa-edit"></i></button>
                <button class="action-btn delete-btn" onclick="confirmDelete(this)"><i class="fas fa-times-circle"></i></button>
                <button class="action-btn invite-btn" onclick="sendInvitation('${student.email}')"><i class="fas fa-paper-plane"></i></button>
            `;
        } else {
            alert("Error updating student: " + data.error);
        }
    })
    .catch(error => {
        console.error("Error updating student:", error);
        alert("An error occurred while updating the student.");
    });
}

        // Confirm deletion of a student
        // Confirm deletion of a student
function confirmDelete(button) {
    let row = button.closest('tr');
    let name = row.cells[2].innerText; // Name is in the third cell (index 2)
    let surname = row.cells[1].innerText; // Surname is in the second cell (index 1)

    // Store student data for deletion
    window.studentDataToDelete = { name, surname };
    
    // Show confirmation dialog
    document.getElementById("confirmation-dialog").style.display = "flex";
    window.rowToDelete = row;  // Store the row reference to remove it later
}

// Delete the student
function deleteStudent() {
    fetch('/pasniedzejs/delete_student', {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(window.studentDataToDelete) // Send name and surname
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.rowToDelete.remove(); // Remove the student row from the table
            document.getElementById("confirmation-dialog").style.display = "none"; // Hide confirmation
        } else {
            alert("Error deleting student: " + data.error);
        }
    })
    .catch(error => {
        console.error("Error deleting student:", error);
        alert("An error occurred while deleting the student.");
    });
}

// Cancel delete action
function cancelDelete() {
    document.getElementById("confirmation-dialog").style.display = "none";
}

        // Cancel delete action
        function cancelDelete() {
            document.getElementById("confirmation-dialog").style.display = "none";
        }

        // Initialize the page with the Students tab open
        openTab('students');

        // Fetch students when the page loads
        function fetchStudents() {
            fetch('/pasniedzejs/get_students')
                .then(response => response.json())
                .then(data => {
                    let tableBody = document.getElementById("student-table-body");
                    tableBody.innerHTML = "";  // Clear table

                    data.forEach(student => {
                        let row = tableBody.insertRow();
                        row.setAttribute("data-id", student.id);  // Ensure the data-id attribute is set
                        row.innerHTML = `
                            <td>
                                <button class="action-btn envelope-btn" onclick="sendEmail('${student.email}')"><i class="fas fa-envelope"></i></button>
                                <button class="action-btn edit-btn" onclick="editStudent(this)"><i class="fas fa-edit"></i></button>
                                <button class="action-btn delete-btn" onclick="confirmDelete(this)"><i class="fas fa-times-circle"></i></button>
                                <button class="action-btn invite-btn" onclick="sendInvitation('${student.email}')"><i class="fas fa-paper-plane"></i></button>
                            </td>
                            <td>${student.surname}</td>
                            <td>${student.name}</td>
                            <td>${student.email}</td>
                        `;
                    });
                })
                .catch(error => {
                    console.error("Error fetching students:", error);
                    alert("An error occurred while fetching the students.");
                });
        }
        fetchStudents();

        document.getElementById('file-input').addEventListener('change', function(event) {
            let file = event.target.files[0];
            let formData = new FormData();
            formData.append('file', file);

            fetch('/pasniedzejs/import_students', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Students imported successfully!");
                    fetchStudents(); // Refresh the student list
                } else {
                    alert("Error importing students: " + data.error);
                }
            })
            .catch(error => {
                console.error("Error importing students:", error);
                alert("An error occurred while importing students.");
            });
        });
        let currentSortColumn = null;
        let isAscending = true;

        function sortTable(columnIndex) {
            // Ja kolonna ir "Actions" (pirmā kolonna), neko nedarām
            if (columnIndex === 0) return;

            const table = document.getElementById("student-table");
            const rows = Array.from(table.rows).slice(1); // Izņemam header rindu
            const headerCells = table.getElementsByTagName("th");

            // Noņemam esošās bultiņas no citām kolonnām
            for (let i = 0; i < headerCells.length; i++) {
                if (i !== columnIndex) {
                    headerCells[i].classList.remove("asc", "desc");
                }
            }

            // Mainām kārtošanas secību, ja tiek noklikšķināts uz vienas un tās pašas kolonnas
            if (currentSortColumn === columnIndex) {
                isAscending = !isAscending;
            } else {
                isAscending = true;
            }

            // Saglabājam pašreizējo kolonnu
            currentSortColumn = columnIndex;

            // Kārtojam rindas
            rows.sort((a, b) => {
                const cellA = a.cells[columnIndex].innerText.trim();
                const cellB = b.cells[columnIndex].innerText.trim();
                return isAscending ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
            });

            // Pievienojam sakārtotās rindas atpakaļ tabulā
            rows.forEach(row => table.tBodies[0].appendChild(row));

            // Pievienojam bultiņu virzienu
            if (isAscending) {
                headerCells[columnIndex].classList.remove("desc");
                headerCells[columnIndex].classList.add("asc");
            } else {
                headerCells[columnIndex].classList.remove("asc");
                headerCells[columnIndex].classList.add("desc");
            }
        }
    // Edit Data
    function editData(button) {
    const inputs = document.querySelectorAll('#profile input');
    let canEdit = false;
    let updatedData = {};

    inputs.forEach(input => {
        if (input.id !== "password") {  // Skip password field (if needed)
            if (input.readOnly) {
                input.readOnly = false;  // Make the field editable
                canEdit = true;  // Mark as editable
            } else {
                input.readOnly = true;  // Make the field readonly

                // Collect the updated data (if it's not readonly)
                updatedData[input.id] = input.value;
            }
        }
    });

    // Change the button text accordingly
    if (canEdit) {
        button.textContent = "Save data"; // If editable, prompt for saving
    } else {
        button.textContent = "Edit data"; // If all fields are readonly, prompt for editing

        // Send updated data to the backend
        sendUpdatedProfileData(updatedData);
    }
}

// Function to send the updated profile data to the backend
function sendUpdatedProfileData(data) {
    fetch('/update-profile', {
        method: 'POST',  // Assuming the backend uses POST to handle the update
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),  // Convert the data to JSON
    })
    .then(response => {
        if (response.ok) {
            alert("Profile updated successfully!");
            // Optionally, you can reload the data or refresh the page to show the updated data
        } else {
            alert("Failed to update profile. Please try again.");
        }
    })
    .catch(error => {
        console.error("Error updating profile:", error);
        alert("An error occurred. Please try again.");
    });
}

function fetchPapers() {
    fetch('/pasniedzejs/get-papers')
        .then(response => response.json())
        .then(data => {
            if (data.papers) {
                renderPapers(data.papers);
            }
        })
        .catch(error => console.error("Error fetching papers:", error));
}

function renderPapers(papers) {
    const tbody = document.getElementById("paper-table-body");
    tbody.innerHTML = "";  // Clear the table before inserting new data

    papers.forEach((paper, index) => {
        const row = document.createElement("tr");

        row.innerHTML = `
            <td>${index + 1}</td>
            <td>${paper.title}</td>
            <td>${paper.student_name}</td>
        `;

        tbody.appendChild(row);
    });
}

document.addEventListener("DOMContentLoaded", () => {
    fetchPapers();
    openTab('papers');  // Open the papers tab by default
});

let currentSeminarNum = null; // Globālais mainīgais, lai saglabātu pašreizējo semināra numuru

async function openSeminarPopup(seminarNum, seminarName) {
    console.log("openSeminarPopup called with seminarNum:", seminarNum); // Debug log

    // ✅ Update the global variable
    currentSeminarNum = seminarNum; 

    // ✅ Update UI elements
    document.getElementById("seminar-popup-title").innerText = seminarName;
    document.getElementById("seminar-popup").setAttribute("data-seminar-num", seminarNum);
    document.getElementById("seminar-popup").style.display = "block";

    try {
        const response = await fetch(`/pasniedzejs/get-seminar-papers/${seminarNum}`);
        if (!response.ok) {
            throw new Error("Failed to fetch papers");
        }
        const data = await response.json();

        console.log("Fetched papers:", data.papers);

        const tbody = document.querySelector("#seminar-popup table tbody");
        tbody.innerHTML = ""; // Clear table

        if (data.papers.length === 0) {
            tbody.innerHTML = "<tr><td colspan='5'>No papers found</td></tr>";
        } else {
            data.papers.forEach((paper, index) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${paper.title}</td>
                    <td>${paper.student_name}</td>
                    <td>${paper.group}</td>
                    <td class="checkbox-cell"><input type="checkbox"></td>
                `;
                tbody.appendChild(row);
            });
        }

    } catch (error) {
        console.error("Error fetching papers:", error);
    }
}

async function registerTeams() {
    console.log("registerTeams called with currentSeminarNum:", currentSeminarNum); // Debug log

    if (!currentSeminarNum) {
        alert("No seminar selected. Please select a seminar first.");
        return;
    }

    const seminarNum = currentSeminarNum;
    console.log("Registering teams for seminarNum:", seminarNum); // Debug log

    let teamInputs = document.getElementsByClassName("team-input");
    let teams = [];
    let allFilled = true;

    for (let input of teamInputs) {
        if (input.value.trim() === "") {
            allFilled = false;
            break;
        }
        teams.push(input.value.trim());
    }

    if (!allFilled) {
        alert("Please fill in all team names.");
        return;
    }

    try {
        const response = await fetch(`/pasniedzejs/register_teams/${seminarNum}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ teams: teams })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Failed to register teams");
        }

        const data = await response.json();

        if (data.message) {
            alert("Teams registered successfully!");
            closeCreateTeamsModal();

            // Reload seminar papers
            const papersResponse = await fetch(`/pasniedzejs/get-seminar-papers/${seminarNum}`);
            const papersData = await papersResponse.json();

            const tbody = document.querySelector("#seminar-popup table tbody");
            tbody.innerHTML = ""; // Clear table

            if (papersData.papers.length === 0) {
                tbody.innerHTML = "<tr><td colspan='5'>No papers found</td></tr>";
            } else {
                papersData.papers.forEach((paper, index) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${paper.title}</td>
                        <td>${paper.student_name}</td>
                        <td>${paper.group}</td>
                        <td class="checkbox-cell"><input type="checkbox"></td>
                    `;
                    tbody.appendChild(row);
                });
            }
        } else {
            alert("Error: " + data.error);
        }
    } catch (error) {
        console.error("Error:", error);
        alert("Error: " + error.message);
    }
}

function exportStudents() {
    fetch('/pasniedzejs/export_students')
        .then(response => {
            if (response.ok) {
                return response.blob();
            } else {
                throw new Error('Failed to export students');
            }
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'students.xlsx';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        })
        .catch(error => {
            console.error('Error exporting students:', error);
            alert('Failed to export students');
        });
}

    </script>
</body>
</html>
